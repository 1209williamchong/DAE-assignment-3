<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="1.3">
    <title>開源軟體清單</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.0/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.0/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.0/css/ionic.bundle.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        ion-card {
            --border-radius: 8px;
            margin: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        ion-card-header {
            display: flex;
            align-items: center;
            padding: 8px;
        }
        .software-icon {
            width: 44px;
            height: 44px;
            margin-right: 8px;
            border-radius: 5px;
            object-fit: contain;
        }
        .favorite-icon {
            font-size: 24px;
            cursor: pointer;
            margin-left: 8px;
            transition: transform 0.3s;
        }
        .favorite-icon.favorited {
            color: var(--ion-color-warning);
            animation: scaleIcon 0.3s ease;
        }
        .software-details {
            flex-grow: 1;
        }
        .software-details ion-card-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .software-details ion-card-subtitle, .software-details p {
            font-size: 12px;
            color: #666;
            margin: 2px 0;
        }
        .category-tag, .tag {
            color: var(--ion-color-primary);
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-block;
            min-width: 44px;
            text-align: center;
            transition: background-color 0.2s;
        }
        .category-tag.selected, .tag.selected {
            background-color: var(--ion-color-primary);
            color: white;
        }
        .video-container {
            padding: 8px;
        }
        .video-container iframe {
            width: 100%;
            max-width: 343px;
            height: 150px;
            border: none;
        }
        .video-error {
            padding: 8px;
            text-align: center;
        }
        .video-error p {
            margin: 0;
        }
        .no-results {
            text-align: center;
            padding: 16px;
            color: #888;
            font-size: 14px;
        }
        .chart-container {
            height: 150px;
            margin: 8px;
            position: relative;
            animation: scaleIn 0.5s ease-out;
        }
        .skeleton-chart {
            width: 150px;
            height: 150px;
            background: #e0e0e0;
            border-radius: 50%;
            margin: 8px auto;
        }
        .skeleton-card {
            margin: 8px;
            padding: 8px;
        }
        ion-list.list-view ion-card {
            width: calc(100% - 16px);
        }
        ion-list.grid-view {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 8px;
        }
        ion-list.grid-view ion-card {
            margin: 0;
            animation: slideIn 0.3s ease-out;
        }
        ion-segment, ion-button {
            margin: 8px;
        }
        mark {
            background: #ffeb3b;
            padding: 0 2px;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-16px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeToggle {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIcon {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @media (max-width: 375px) {
            ion-searchbar {
                --padding-start: 8px;
                --padding-end: 8px;
                font-size: 14px;
            }
            ion-segment, ion-select, ion-toggle, ion-button {
                font-size: 12px;
            }
            ion-datetime-button {
                --padding-end: 8px;
            }
            ion-card {
                margin: 6px;
            }
            .software-icon {
                width: 36px;
                height: 36px;
            }
            .favorite-icon {
                font-size: 20px;
            }
            .software-details ion-card-title {
                font-size: 13px;
            }
            .software-details ion-card-subtitle, .software-details p {
                font-size: 10px;
            }
            .video-container iframe {
                max-width: 100%;
                height: 140px;
            }
            .video-error {
                font-size: 10px;
                padding: 6px;
            }
            .category-tag, .tag {
                padding: 2px 4px;
                font-size: 10px;
                min-width: 40px;
            }
            ion-list.grid-view {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                padding: 6px;
            }
            .chart-container {
                height: 140px;
            }
            .skeleton-chart {
                width: 140px;
                height: 140px;
            }
            .chart-container canvas {
                max-width: 140px !important;
                max-height: 140px !important;
            }
        }
        ion-content {
            --padding-bottom: 120px;
        }
        .fade-toggle {
            animation: fadeToggle 0.2s ease-in-out;
        }
    </style>
</head>
<body>
    <ion-app>
        <ion-header>
            <ion-toolbar>
                <ion-title>開源軟體清單</ion-title>
            </ion-toolbar>
            <ion-searchbar id="searchInput" placeholder="搜尋..." debounce="300"></ion-searchbar>
            <ion-item>
                <ion-select label="搜尋欄位" id="searchFields" interface="popover" multiple="true">
                    <ion-select-option value="name">名稱</ion-select-option>
                    <ion-select-option value="version">版本</ion-select-option>
                    <ion-select-option value="description">描述</ion-select-option>
                    <ion-select-option value="tags">標籤</ion-select-option>
                </ion-select>
                <ion-toggle id="exactMatch" slot="end">精確搜尋</ion-toggle>
            </ion-item>
            <ion-segment id="viewToggle" value="list">
                <ion-segment-button value="list">
                    <ion-label>列表</ion-label>
                </ion-segment-button>
                <ion-segment-button value="grid">
                    <ion-label>網格</ion-label>
                </ion-segment-button>
            </ion-segment>
            <ion-item>
                <ion-select label="排序方式" id="sortSelect" interface="popover" value="name">
                    <ion-select-option value="name">名稱</ion-select-option>
                    <ion-select-option value="version">版本</ion-select-option>
                </ion-select>
                <ion-toggle id="sortDirection" slot="end" checked>降冪</ion-toggle>
            </ion-item>
            <ion-item>
                <ion-select label="分類" interface="popover" id="categorySelect" multiple="true">
                    <ion-select-option value="">全部</ion-select-option>
                    <ion-select-option value="favorites">收藏</ion-select-option>
                    <ion-select-option value="網頁瀏覽器">網頁瀏覽器</ion-select-option>
                    <ion-select-option value="作業系統">作業系統</ion-select-option>
                    <ion-select-option value="辦公室軟體">辦公室軟體</ion-select-option>
                    <ion-select-option value="圖像編輯器">圖像編輯器</ion-select-option>
                    <ion-select-option value="版本控制">版本控制</ion-select-option>
                    <ion-select-option value="程式設計工具">程式設計工具</ion-select-option>
                    <ion-select-option value="資料庫">資料庫</ion-select-option>
                    <ion-select-option value="媒體播放器">媒體播放器</ion-select-option>
                    <ion-select-option value="檔案管理">檔案管理</ion-select-option>
                    <ion-select-option value="網頁伺服器">網頁伺服器</ion-select-option>
                </ion-select>
            </ion-item>
            <ion-item>
                <ion-label>日期範圍</ion-label>
                <ion-datetime-button datetime="startDate"></ion-datetime-button>
                <ion-datetime-button datetime="endDate"></ion-datetime-button>
            </ion-item>
            <ion-modal>
                <ion-datetime id="startDate" presentation="date" max="2025-12-31"></ion-datetime>
                <ion-datetime id="endDate" presentation="date" max="2025-12-31"></ion-datetime>
            </ion-modal>
            <ion-button id="resetFilters" expand="block" color="light">重設過濾</ion-button>
        </ion-header>
        <ion-content class="ion-padding">
            <div class="chart-container">
                <div class="skeleton-chart" style="display: block;"></div>
                <canvas id="categoryChart" style="display: none;"></canvas>
            </div>
            <ion-list id="softwareListContainer" class="list-view">
                <div class="skeleton-card">
                    <ion-skeleton-text animated style="width: 100%; height: 20px; margin-bottom: 8px;"></ion-skeleton-text>
                    <ion-skeleton-text animated style="width: 80%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
                    <ion-skeleton-text animated style="width: 60%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
                    <ion-skeleton-text animated style="width: 100%; height: 150px;"></ion-skeleton-text>
                </div>
                <div class="skeleton-card">
                    <ion-skeleton-text animated style="width: 100%; height: 20px; margin-bottom: 8px;"></ion-skeleton-text>
                    <ion-skeleton-text animated style="width: 80%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
                    <ion-skeleton-text animated style="width: 60%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
                    <ion-skeleton-text animated style="width: 100%; height: 150px;"></ion-skeleton-text>
                </div>
            </ion-list>
        </ion-content>
    </ion-app>
    <script>
        const softwareData = [
            {
                name: "Mozilla Firefox",
                version: "125.0.1",
                license: "Mozilla Public License 2.0",
                category: "網頁瀏覽器",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Firefox_logo%2C_2019.svg/120px-Firefox_logo%2C_2019.svg.png",
                video: "https://www.youtube.com/embed/lmeDvSgN6zY?si=xlXxFoMH45yjawIL",
                description: "Mozilla Firefox 是一款快速、安全的開源網頁瀏覽器，支持眾多擴充功能。",
                tags: ["瀏覽器", "網頁", "開源"],
                date: "2025-04-01"
            },
            {
                name: "Linux (Ubuntu)",
                version: "24.04 LTS",
                license: "GNU General Public License (GPL)",
                category: "作業系統",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Ubuntu-logo-2022.svg/250px-Ubuntu-logo-2022.svg.png",
                video: "https://www.youtube.com/embed/lmeDvSgN6zY?si=TONUdRZXqLeqDw9R",
                description: "Ubuntu 是基於 Linux 的開源作業系統，適合桌面和伺服器使用。",
                tags: ["Linux", "作業系統", "開源"],
                date: "2025-04-15"
            },
            {
                name: "LibreOffice",
                version: "24.2.3",
                license: "Mozilla Public License v2.0",
                category: "辦公室軟體",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/LibreOffice_Logo_Flat.svg/120px-LibreOffice_Logo_Flat.svg.png",
                video: "https://www.youtube.com/embed/4RiUYjIZEug?si=jcAn2tBqoVu0uRT4",
                description: "LibreOffice 是一套免費的開源辦公軟體，包含文書、試算表等工具。",
                tags: ["辦公室", "文書處理", "開源"],
                date: "2025-03-10"
            },
            {
                name: "GIMP",
                version: "2.10.36",
                license: "GNU General Public License v3.0",
                category: "圖像編輯器",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/67/The_GIMP_icon_-_v3.0.svg/120px-The_GIMP_icon_-_v3.0.svg.png",
                video: "https://www.youtube.com/embed/LX-S1CX1HUI?si=MWupQoM7QZ-1E8R9",
                description: "GIMP 是一款功能強大的開源圖像編輯軟體，類似 Photoshop。",
                tags: ["圖像編輯", "設計", "開源"],
                date: "2025-02-20"
            },
            {
                name: "Git",
                version: "2.45.0",
                license: "GNU General Public License v2.0",
                category: "版本控制",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Git-logo.svg/800px-Git-logo.svg.png",
                video: "https://www.youtube.com/embed/8JJ101D3knE?si=iL64PAW-U6eI-Rs1",
                description: "Git 是一款分散式版本控制系統，廣泛用於程式碼管理。",
                tags: ["版本控制", "程式設計", "開源"],
                date: "2025-04-05"
            },
            {
                name: "Visual Studio Code",
                version: "1.88.0",
                license: "MIT License",
                category: "程式設計工具",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Visual_Studio_Code_1.35_icon.svg/800px-Visual_Studio_Code_1.35_icon.svg.png",
                video: "https://www.youtube.com/embed/KMxo3T_MTvY",
                description: "VS Code 是一款輕量、強大的開源程式碼編輯器。",
                tags: ["編輯器", "程式設計", "開源"],
                date: "2025-03-15"
            },
            {
                name: "MySQL",
                version: "8.4.0",
                license: "GNU General Public License v2.0",
                category: "資料庫",
                icon: "https://upload.wikimedia.org/wikipedia/zh/thumb/6/62/MySQL.svg/136px-MySQL.svg.png",
                video: "https://www.youtube.com/embed/OM4aZJW_Ojs",
                description: "MySQL 是一款高效的開源關聯式資料庫管理系統。",
                tags: ["資料庫", "後端", "開源"],
                date: "2025-01-10"
            },
            {
                name: "VLC Media Player",
                version: "3.0.21",
                license: "GNU General Public License v2.0",
                category: "媒體播放器",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/VLC_Icon.svg/120px-VLC_Icon.svg.png",
                video: "https://www.youtube.com/embed/sRn7WAGFlyg?si=XVCOtEq7bLXF6Chm",
                description: "VLC 是一款支援多格式的開源媒體播放器。",
                tags: ["媒體", "播放器", "開源"],
                date: "2025-02-15"
            },
            {
                name: "Inkscape",
                version: "1.4.0",
                license: "GNU General Public License v3.0",
                category: "圖像編輯器",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Inkscape_Logo.svg/120px-Inkscape_Logo.svg.png",
                video: "https://www.youtube.com/embed/pa6a7oz7vEE",
                description: "Inkscape 是一款用於向量圖形的開源編輯工具。",
                tags: ["向量圖形", "設計", "開源"],
                date: "2025-03-01"
            },
            {
                name: "Apache HTTP Server",
                version: "2.4.62",
                license: "Apache License 2.0",
                category: "網頁伺服器",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/45/Apache_HTTP_server_logo_%282016%29.png/250px-Apache_HTTP_server_logo_%282016%29.png",
                video: "https://www.youtube.com/embed/1CDxpAzvLKY?si",
                description: "Apache 是全球廣泛使用的開源網頁伺服器軟體。",
                tags: ["伺服器", "網頁", "開源"],
                date: "2025-04-10"
            },
            {
                name: "Eclipse",
                version: "4.31.0",
                license: "Eclipse Public License 2.0",
                category: "程式設計工具",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/Eclipse-Luna-Logo.svg/250px-Eclipse-Luna-Logo.svg.png",
                video: "https://www.youtube.com/embed/RJPL8oSYWGo?si=DUXoIvGkEo9VPdcd",
                description: "Eclipse 是一款開源的整合開發環境，適合 Java 開發。",
                tags: ["IDE", "程式設計", "開源"],
                date: "2025-02-10"
            },
            {
                name: "PostgreSQL",
                version: "17.0",
                license: "PostgreSQL License",
                category: "資料庫",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2e/Pg_logo.png/120px-Pg_logo.png",
                video: "https://www.youtube.com/embed/SpfIwlAYaKk?si=Gp5DHDu4pKmStoDO",
                description: "PostgreSQL 是一款強大的開源物件關聯式資料庫。",
                tags: ["資料庫", "後端", "開源"],
                date: "2025-03-20"
            },
            {
                name: "7-Zip",
                version: "24.03",
                license: "GNU Lesser General Public License",
                category: "檔案管理",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/7ziplogo.svg/120px-7ziplogo.svg.png",
                video: "https://www.youtube.com/embed/AR15eWlJG6I?si=j-hDVOc5ECGtcf8w",
                description: "7-Zip 是一款高效的開源檔案壓縮工具。",
                tags: ["壓縮", "檔案", "開源"],
                date: "2025-01-15"
            },
            {
                name: "Chromium",
                version: "124.0.6367.0",
                license: "BSD License",
                category: "網頁瀏覽器",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Chromium_Logo.svg/120px-Chromium_Logo.svg.png",
                video: "https://www.youtube.com/embed/oc85UCMI9tA?si=BIR7f0d7e7LYsXsM",
                description: "Chromium 是 Chrome 的開源基礎，注重隱私和性能。",
                tags: ["瀏覽器", "網頁", "開源"],
                date: "2025-04-03"
            },
            {
                name: "Debian",
                version: "12.5",
                license: "GNU General Public License",
                category: "作業系統",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4a/Debian-OpenLogo.svg/80px-Debian-OpenLogo.svg.png",
                video: "https://www.youtube.com/embed/zOZEkzwhThc?si=uWG2q32PgnaHllu3",
                description: "Debian 是一款穩定、靈活的開源 Linux 發行版。",
                tags: ["Linux", "作業系統", "開源"],
                date: "2025-02-25"
            },
            {
                name: "Node.js",
                version: "22.0.0",
                license: "MIT License",
                category: "程式設計工具",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/Node.js_logo.svg/120px-Node.js_logo.svg.png",
                video: "https://www.youtube.com/embed/TlB_eWDSMt4",
                description: "Node.js 是基於 JavaScript 的開源伺服器執行環境。",
                tags: ["JavaScript", "後端", "開源"],
                date: "2025-04-12"
            },
            {
                name: "Audacity",
                version: "3.5.0",
                license: "GNU General Public License v2.0",
                category: "媒體播放器",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Audacity_Logo_With_Name.png/253px-Audacity_Logo_With_Name.png",
                video: "https://www.youtube.com/embed/yzJ2VyYkmaA?si=NbUHoZBKhUSO8gUp",
                description: "Audacity 是一款開源的音訊編輯和錄製軟體。",
                tags: ["音訊", "編輯", "開源"],
                date: "2025-03-05"
            },
            {
                name: "FileZilla",
                version: "3.67.0",
                license: "GNU General Public License v2.0",
                category: "檔案管理",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/01/FileZilla_logo.svg/120px-FileZilla_logo.svg.png",
                video: "https://www.youtube.com/embed/adxmlHDim6c?si=8xmLQmo_JBfppwUJ",
                description: "FileZilla 是一款開源的 FTP 檔案傳輸工具。",
                tags: ["FTP", "檔案", "開源"],
                date: "2025-02-05"
            },
            {
                name: "NGINX",
                version: "1.26.0",
                license: "BSD License",
                category: "網頁伺服器",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Nginx_logo.svg/160px-Nginx_logo.svg.png",
                video: "https://www.youtube.com/embed/9t9Mp0BGnyI?si=HBN2w57Eovc53HBa",
                description: "NGINX 是一款高效的開源網頁伺服器和反向代理。",
                tags: ["伺服器", "網頁", "開源"],
                date: "2025-01-20"
            },
            {
                name: "Apache OpenOffice",
                version: "4.1.16",
                license: "Apache License 2.0",
                category: "辦公室軟體",
                icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/70/Apache_OpenOffice_logo_and_wordmark_%282014%29.svg/250px-Apache_OpenOffice_logo_and_wordmark_%282014%29.svg.png",
                video: "https://www.youtube.com/embed/oJnCEqeAsUk?si=DK4U65M-g08oD4Ji",
                description: "Apache OpenOffice 是一套開源辦公軟體，支援多種文件格式。",
                tags: ["辦公室", "文書處理", "開源"],
                date: "2025-04-08"
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const searchFields = document.getElementById('searchFields');
            const exactMatch = document.getElementById('exactMatch');
            const viewToggle = document.getElementById('viewToggle');
            const categorySelect = document.getElementById('categorySelect');
            const sortSelect = document.getElementById('sortSelect');
            const sortDirection = document.getElementById('sortDirection');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const resetFilters = document.getElementById('resetFilters');
            const container = document.getElementById('softwareListContainer');
            const chartCanvas = document.getElementById('categoryChart');
            const skeletonChart = document.querySelector('.skeleton-chart');

            let chartInstance = null;
            let activeTags = [];
            let activeCategoryTags = [];
            let favorites = JSON.parse(localStorage.getItem('softwareFavorites')) || [];
            let isLoading = true;

            // 動態生成 ion-card
            function createSoftwareCard(data) {
                const isFavorited = favorites.includes(data.name);
                const card = document.createElement('ion-card');
                card.dataset.category = data.category;
                card.dataset.date = data.date;
                card.dataset.name = data.name;
                card.innerHTML = `
                    <ion-card-header>
                        <img src="${data.icon}" alt="${data.name} 圖示" class="software-icon">
                        <div class="software-details">
                            <ion-card-title>${data.name}</ion-card-title>
                            <ion-card-subtitle>版本：${data.version}</ion-card-subtitle>
                            <ion-card-subtitle>授權：${data.license}</ion-card-subtitle>
                        </div>
                        <ion-icon name="${isFavorited ? 'star' : 'star-outline'}" class="favorite-icon ${isFavorited ? 'favorited' : ''}"></ion-icon>
                    </ion-card-header>
                    <ion-card-content>
                        <p>描述：${data.description}</p>
                        <p>分類：<span class="category-tag">${data.category}</span></p>
                        <p>標籤：${data.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}</p>
                        <div class="video-container" data-video="${data.video}">
                            <iframe data-src="${data.video}" title="${data.name} 示範影片" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
                            <div class="video-error" style="display: none;">
                                <p style="color: red; font-size: 12px;">影片無法載入，請檢查網路或稍後重試</p>
                                <p style="font-size: 12px;">${data.description}</p>
                            </div>
                        </div>
                    </ion-card-content>
                `;
                return card;
            }

            const softwareCards = softwareData.map(data => createSoftwareCard(data));

            // 延遲載入影片
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const iframe = entry.target.querySelector('iframe');
                        const errorDiv = entry.target.querySelector('.video-error');
                        iframe.src = iframe.dataset.src;
                        iframe.onerror = () => {
                            iframe.style.display = 'none';
                            errorDiv.style.display = 'block';
                        };
                        observer.unobserve(entry.target);
                    }
                });
            }, { rootMargin: '0px 0px 100px 0px' });

            // 綁定觀察
            function bindObservers() {
                container.querySelectorAll('.video-container').forEach(container => {
                    const iframe = container.querySelector('iframe');
                    if (iframe && !iframe.src) {
                        observer.observe(container);
                    }
                });
            }

            // 綁定標籤和收藏事件
            function bindTagEvents() {
                container.querySelectorAll('.category-tag').forEach(tag => {
                    tag.addEventListener('click', () => {
                        const category = tag.textContent;
                        if (activeCategoryTags.includes(category)) {
                            activeCategoryTags = activeCategoryTags.filter(t => t !== category);
                            tag.classList.remove('selected');
                        } else {
                            activeCategoryTags.push(category);
                            tag.classList.add('selected');
                        }
                        saveFilters();
                        applyFilters();
                    });
                });
                container.querySelectorAll('.tag').forEach(tag => {
                    tag.addEventListener('click', () => {
                        const tagName = tag.textContent;
                        if (activeTags.includes(tagName)) {
                            activeTags = activeTags.filter(t => t !== tagName);
                            tag.classList.remove('selected');
                        } else {
                            activeTags.push(tagName);
                            tag.classList.add('selected');
                        }
                        saveFilters();
                        applyFilters();
                    });
                });
                container.querySelectorAll('.favorite-icon').forEach(icon => {
                    icon.addEventListener('click', () => {
                        const card = icon.closest('ion-card');
                        const name = card.dataset.name;
                        if (favorites.includes(name)) {
                            favorites = favorites.filter(f => f !== name);
                            icon.name = 'star-outline';
                            icon.classList.remove('favorited');
                        } else {
                            favorites.push(name);
                            icon.name = 'star';
                            icon.classList.add('favorited');
                        }
                        localStorage.setItem('softwareFavorites', JSON.stringify(favorites));
                        applyFilters();
                    });
                });
            }

            // 更新圖表
            function updateChart(filteredData) {
                const categories = softwareData.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + 1;
                    return acc;
                }, {});
                const filteredCategories = filteredData.reduce((acc, item) => {
                    const data = softwareData.find(d => d.name === item.querySelector('ion-card-title').textContent);
                    acc[data.category] = (acc[data.category] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(categories);
                const data = labels.map(label => filteredCategories[label] || 0);
                const backgroundColors = labels.map((_, i) => `hsl(${i * 36}, 70%, 50%)`);

                if (chartInstance) {
                    chartInstance.destroy();
                }

                chartInstance = new Chart(chartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels,
                        datasets: [{
                            data,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: { size: 12 },
                                    padding: 10
                                }
                            }
                        }
                    }
                });
            }

            // 解析版本號
            function parseVersion(str) {
                const versionMatch = str.match(/[\d\.]+(?:\s*LTS)?/);
                if (!versionMatch) return [0];
                const version = versionMatch[0].replace(/\s*LTS/, '');
                return version.split('.').map(Number);
            }

            // 比較版本號
            function compareVersions(a, b) {
                const aParts = parseVersion(a);
                const bParts = parseVersion(b);
                for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                    const aVal = aParts[i] || 0;
                    const bVal = bParts[i] || 0;
                    if (aVal !== bVal) return aVal - bVal;
                }
                return 0;
            }

            // 解析日期
            function parseDate(str) {
                return str ? new Date(str) : null;
            }

            // 高亮搜尋
            function highlightText(text, term, exact) {
                if (!term) return text;
                if (exact) {
                    return text === term ? `<mark>${text}</mark>` : text;
                }
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            }

            // 保存過濾設定
            function saveFilters() {
                const filters = {
                    search: searchInput.value,
                    searchFields: searchFields.value,
                    exactMatch: exactMatch.checked,
                    view: viewToggle.value,
                    categories: categorySelect.value,
                    sortBy: sortSelect.value,
                    sortDirection: sortDirection.checked,
                    startDate: startDateInput.value,
                    endDate: endDateInput.value,
                    activeCategoryTags,
                    activeTags
                };
                localStorage.setItem('softwareFilters', JSON.stringify(filters));
            }

            // 載入過濾設定
            function loadFilters() {
                const filters = JSON.parse(localStorage.getItem('softwareFilters'));
                if (filters) {
                    searchInput.value = filters.search || '';
                    searchFields.value = filters.searchFields || ['name', 'description', 'tags'];
                    exactMatch.checked = filters.exactMatch || false;
                    viewToggle.value = filters.view || 'list';
                    categorySelect.value = filters.categories || [''];
                    sortSelect.value = filters.sortBy || 'name';
                    sortDirection.checked = filters.sortDirection !== undefined ? filters.sortDirection : true;
                    startDateInput.value = filters.startDate || '';
                    endDateInput.value = filters.endDate || '';
                    activeCategoryTags = filters.activeCategoryTags || [];
                    activeTags = filters.activeTags || [];
                    container.classList.remove('list-view', 'grid-view');
                    container.classList.add(`${viewToggle.value}-view`);
                } else {
                    searchFields.value = ['name', 'description', 'tags'];
                }
            }

            // 應用過濾與排序
            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedFields = Array.isArray(searchFields.value) ? searchFields.value : [];
                const isExact = exactMatch.checked;
                const selectedCategories = Array.isArray(categorySelect.value) ? categorySelect.value.filter(v => v !== '') : [];
                const sortBy = sortSelect.value;
                const isDescending = sortDirection.checked;
                const startDate = parseDate(startDateInput.value);
                const endDate = parseDate(endDateInput.value);

                let filtered = softwareCards.filter(card => {
                    const title = card.querySelector('ion-card-title').textContent;
                    const data = softwareData.find(d => d.name === title);
                    const name = data.name.toLowerCase();
                    const version = data.version.toLowerCase();
                    const desc = data.description.toLowerCase();
                    const tags = data.tags.map(t => t.toLowerCase());
                    const category = card.dataset.category;
                    const itemDate = parseDate(card.dataset.date);

                    let matchesSearch = true;
                    if (searchTerm && selectedFields.length > 0) {
                        matchesSearch = selectedFields.some(field => {
                            if (field === 'name') {
                                return isExact ? name === searchTerm : name.includes(searchTerm);
                            } else if (field === 'version') {
                                return isExact ? version === searchTerm : version.includes(searchTerm);
                            } else if (field === 'description') {
                                return isExact ? desc === searchTerm : desc.includes(searchTerm);
                            } else if (field === 'tags') {
                                return tags.some(tag => isExact ? tag === searchTerm : tag.includes(searchTerm));
                            }
                            return false;
                        });
                    }

                    const matchesCategory = selectedCategories.length === 0 || 
                        selectedCategories.includes(category) || 
                        (selectedCategories.includes('favorites') && favorites.includes(data.name));
                    const matchesCategoryTags = activeCategoryTags.length === 0 || activeCategoryTags.includes(category);
                    const matchesTags = activeTags.length === 0 || tags.some(tag => activeTags.includes(tag));
                    const matchesDate = (!startDate || (itemDate && itemDate >= startDate)) &&
                                       (!endDate || (itemDate && itemDate <= endDate));

                    if (matchesSearch && searchTerm && selectedFields.length > 0) {
                        if (selectedFields.includes('name')) {
                            card.querySelector('ion-card-title').innerHTML = highlightText(data.name, searchTerm, isExact);
                        }
                        if (selectedFields.includes('description')) {
                            card.querySelector('ion-card-content p:first-child').innerHTML = `描述：${highlightText(data.description, searchTerm, isExact)}`;
                        }
                        if (selectedFields.includes('tags')) {
                            const tagEls = card.querySelectorAll('.tag');
                            tagEls.forEach((el, i) => {
                                el.innerHTML = highlightText(data.tags[i], searchTerm, isExact);
                            });
                        }
                    } else {
                        card.querySelector('ion-card-title').innerHTML = data.name;
                        card.querySelector('ion-card-content p:first-child').innerHTML = `描述：${data.description}`;
                        const tagEls = card.querySelectorAll('.tag');
                        tagEls.forEach((el, i) => {
                            el.innerHTML = data.tags[i];
                        });
                    }

                    return matchesSearch && matchesCategory && matchesCategoryTags && matchesTags && matchesDate;
                });

                // 排序
                filtered.sort((a, b) => {
                    let aVal, bVal;
                    if (sortBy === 'name') {
                        aVal = a.querySelector('ion-card-title').textContent.toLowerCase();
                        bVal = b.querySelector('ion-card-title').textContent.toLowerCase();
                        return aVal.localeCompare(bVal);
                    } else if (sortBy === 'version') {
                        aVal = a.querySelector('ion-card-subtitle').textContent;
                        bVal = b.querySelector('ion-card-subtitle').textContent;
                        return compareVersions(aVal, bVal);
                    }
                    return 0;
                });

                if (isDescending) filtered.reverse();

                // 更新 DOM
                container.innerHTML = '';
                if (filtered.length === 0) {
                    container.innerHTML = '<p class="no-results">無符合結果</p>';
                } else {
                    container.classList.add('fade-toggle');
                    filtered.forEach(card => container.appendChild(card));
                    bindTagEvents();
                    bindObservers();
                    updateChart(filtered);
                    setTimeout(() => container.classList.remove('fade-toggle'), 200);
                }

                saveFilters();
            }

            // 視圖切換
            viewToggle.addEventListener('ionChange', e => {
                container.classList.remove('list-view', 'grid-view');
                container.classList.add(`${e.detail.value}-view`);
                container.classList.add('fade-toggle');
                applyFilters();
                setTimeout(() => container.classList.remove('fade-toggle'), 200);
                saveFilters();
            });

            // 重設過濾
            resetFilters.addEventListener('click', () => {
                localStorage.removeItem('softwareFilters');
                searchInput.value = '';
                searchFields.value = ['name', 'description', 'tags'];
                exactMatch.checked = false;
                viewToggle.value = 'list';
                categorySelect.value = [''];
                sortSelect.value = 'name';
                sortDirection.checked = true;
                startDateInput.value = '';
                endDateInput.value = '';
                activeCategoryTags = [];
                activeTags = [];
                container.classList.remove('list-view', 'grid-view');
                container.classList.add('list-view');
                applyFilters();
            });

            // 綁定事件
            searchInput.addEventListener('ionInput', applyFilters);
            searchFields.addEventListener('ionChange', applyFilters);
            exactMatch.addEventListener('ionChange', applyFilters);
            categorySelect.addEventListener('ionChange', applyFilters);
            sortSelect.addEventListener('ionChange', applyFilters);
            sortDirection.addEventListener('ionChange', applyFilters);
            startDateInput.addEventListener('ionChange', applyFilters);
            endDateInput.addEventListener('ionChange', applyFilters);

            // 初始化
            loadFilters();
            setTimeout(() => {
                isLoading = false;
                container.innerHTML = '';
                skeletonChart.style.display = 'none';
                chartCanvas.style.display = 'block';
                applyFilters();
            }, 1000);
        });
    </script>
</body>
</html>